name: manual-build
run-name: ${{ github.actor }} is running manual build workflow
on:
  workflow_dispatch:
    inputs:
      FORCE_UPLOAD:
        required: true
        type: boolean
        default: false
jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      IMAGE: "${{ vars.GKE_IMAGE }}-${{ github.ref_name }}.${{ github.sha }}"
      BUILD_SIGNATURE: "${{github.run_id}}-${{ github.ref_name }}.${{ github.sha }}"
    steps:
      - run: echo "Build docker image with tag ${{ vars.GKE_IMAGE }}-${{ github.ref_name }}.${{ github.sha }}"
      - run: echo "Build signature ${{ github.ref_name }}.${{ github.sha }}"
      - run: echo "Login to GKE credential ${{ secrets.GKE_CREDENTIALS }}"
      - run: echo "Upload build to ${{ vars.GKE_REPO }}"

  build:
    if: inputs.FORCE_UPLOAD
    needs: [init]
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to GAR
        uses: docker/login-action@v2
        with:
          registry: asia.gcr.io-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GKE_CREDENTIALS }}
      #- run: echo "Build ${{ github.run_id }}"
      #- run: echo "branch ${{ inputs.BRANCH }}"
      #- run: echo "commit hash ${{ inputs.COMMIT }}"
      # - run: npm i
      # - run: npm run build
      # - run: echo "Push image @${{ github.run_id }}-${{ inputs.COMMIT }} to Artifact registry"
      # - run: echo "${{ env.DOCKER_IMAGE }}"
